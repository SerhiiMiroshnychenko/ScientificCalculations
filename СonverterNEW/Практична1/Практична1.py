# --- Вхідні дані ---  # Початок блоку введення вихідних параметрів для розрахунку
variant_no = 20  # Номер варіанта (використовується для ідентифікації розрахунку)
m_charge = 1000.0  # Загальна маса металевої шихти (чавун + брухт) у кг

# Склад чавуну (%)  # Вміст хімічних елементів у рідкому чавуні (вихідні дані)
Si_hm = 1.40  # Вміст кремнію в чавуні, %
Mn_hm = 0.70  # Вміст марганцю в чавуні, %
P_hm = 0.04  # Вміст фосфору в чавуні, %
C_hm = 4.60  # Вміст вуглецю в чавуні, %

# Параметри шихти та процесу  # Технологічні показники та вимоги до плавки
w_scr = 0.300  # Масова частка брухту в металевій шихті (значення від 0 до 1)
B = 3.4  # Задана основність шлаку (цільове відношення CaO до SiO2)

# Склад брухту (%)  # Типовий вміст елементів у сталевому брухті (прийняті константи)
Si_scr = 0.25  # Вміст кремнію в брухті, %
Mn_scr = 0.40  # Вміст марганцю в брухті, %
P_scr = 0.02  # Вміст фосфору в брухті, %
C_scr = 0.20  # Вміст вуглецю в брухті, %

# Залишковий вміст у сталі (%)  # Вміст елементів у металі після закінчення плавки
Si_st = 0.005  # Кінцевий вміст кремнію в сталі, %
Mn_st = 0.10  # Кінцевий вміст марганцю в сталі, %
P_st = 0.015  # Кінцевий вміст фосфору в сталі, %
C_st = 0.10  # Кінцевий вміст вуглецю в сталі, %

# Параметри  # Додаткові коефіцієнти для моделі розрахунку
alpha_CO = 0.90  # Частка вуглецю, що окиснюється до CO (решта перетворюється на CO2)
x_CaO_lime = 0.90  # Масова частка оксиду кальцію у вапні (якість флюсу)
x_SiO2_lime = 0.02  # Масова частка діоксиду кремнію у вапні
k_main = 0.80  # Коефіцієнт, що враховує частку головних оксидів у масі шлаку
w_FeO = 0.15  # Прийнята масова частка оксиду заліза у шлаку
k_dust = 0.015  # Коефіцієнт втрат металу з пилом від загальної маси шихти

# Молярні маси  # Атомні та молекулярні маси для хімічних розрахунків, г/моль
M_Si = 28.0855  # Кремній
M_SiO2 = 60.0843  # Діоксид кремнію
M_Mn = 54.9380  # Марганець
M_MnO = 70.9374  # Оксид марганцю
M_P = 30.9738  # Фосфор
M_P2O5 = 141.9445  # Оксид фосфору
M_C = 12.011  # Вуглець
M_CO = 28.010  # Монооксид вуглецю
M_CO2 = 44.009  # Діоксид вуглецю
M_Fe = 55.845  # Залізо
M_FeO = 71.844  # Оксид заліза

# --- Розрахунок ---  # Початок обчислювальної частини алгоритму
m_hm = m_charge * (1.0 - w_scr)  # Визначення маси рідкого чавуну в шихті, кг
m_scr = m_charge * w_scr  # Визначення маси сталевого брухту в шихті, кг

# Розрахунок загальної маси кожного елемента, що надійшов із шихтовими матеріалами
Si_in = m_hm * (Si_hm / 100) + m_scr * (Si_scr / 100)  # Загальна маса кремнію, кг
Mn_in = m_hm * (Mn_hm / 100) + m_scr * (Mn_scr / 100)  # Загальна маса марганцю, кг
P_in = m_hm * (P_hm / 100) + m_scr * (P_scr / 100)  # Загальна маса фосфору, кг
C_in = m_hm * (C_hm / 100) + m_scr * (C_scr / 100)  # Загальна маса вуглецю, кг

eps_steel = 0.1  # Допустима похибка для зупинки ітераційного уточнення маси сталі, кг
max_iter = 50  # Обмеження кількості ітерацій для запобігання зацикленню
iter_no = 0  # Лічильник фактично виконаних ітерацій
m_steel0 = m_charge  # Початкове наближення маси сталі (приймаємо рівним масі шихти)
ok = True  # Прапор успішного виконання розрахунку (за замовчуванням "так")

# Ініціалізація змінних перед циклом  # Підготовка комірок пам'яті для результатів
m_steel = 0  # Кінцева маса сталі
Yield = 0  # Вихід придатного металу у відсотках
m_slag = 0  # Кінцева маса шлаку
m_lime = 0  # Необхідна маса вапна
dSi, dMn, dP, dC = 0, 0, 0, 0  # Маси елементів, що перейшли в оксиди/гази
m_SiO2_ox, m_MnO_ox, m_P2O5_ox = 0, 0, 0  # Маси отриманих оксидів у шлаку
m_Fe_to_slag, m_dust = 0, 0  # Маси втраченого заліза

while True:  # Початок циклу ітераційного уточнення (повторюється до збіжності)
    # Розрахунок маси домішок, що залишилися в готовому металі (залежить від поточної маси сталі)
    Si_st_mass = m_steel0 * (Si_st / 100)  # Залишок кремнію, кг
    Mn_st_mass = m_steel0 * (Mn_st / 100)  # Залишок марганцю, кг
    P_st_mass = m_steel0 * (P_st / 100)  # Залишок фосфору, кг
    C_st_mass = m_steel0 * (C_st / 100)  # Залишок вуглецю, кг

    # Розрахунок маси окиснених елементів (різниця між початковим і залишковим вмістом)
    dSi = max(0, Si_in - Si_st_mass)  # Маса кремнію, що окислився, кг
    dMn = max(0, Mn_in - Mn_st_mass)  # Маса марганцю, що окислився, кг
    dP = max(0, P_in - P_st_mass)  # Маса фосфору, що окислився, кг
    dC = max(0, C_in - C_st_mass)  # Маса вуглецю, що перейшов у гази, кг

    # Перерахунок маси елементів у масу оксидів за допомогою молярних мас (стехіометрія)
    m_SiO2_ox = dSi * (M_SiO2 / M_Si)  # Маса діоксиду кремнію, кг
    m_MnO_ox = dMn * (M_MnO / M_Mn)  # Маса оксиду марганцю, кг
    m_P2O5_ox = dP * (M_P2O5 / (2.0 * M_P))  # Маса оксиду фосфору, кг

    # Розрахунок маси газів, що утворюються при окисненні вуглецю
    m_CO = alpha_CO * dC * (M_CO / M_C)  # Маса монооксиду вуглецю (чадний газ), кг
    m_CO2 = (1.0 - alpha_CO) * dC * (M_CO2 / M_C)  # Маса діоксиду вуглецю (вуглекислий газ), кг

    # Обчислення знаменника для формули вапна (ефективність вапна з урахуванням власних домішок)
    denom = x_CaO_lime - B * x_SiO2_lime

    if denom <= 0:  # Перевірка умови: чи дозволяє якість вапна отримати задану основність
        print('Помилка: неможливо забезпечити основність.')  # Вивід повідомлення про помилку
        ok = False  # Позначення розрахунку як невдалого
        break  # Примусове завершення циклу

    m_lime = (B * m_SiO2_ox) / denom  # Розрахунок необхідної кількості вапна, кг
    m_CaO_total = m_lime * x_CaO_lime  # Загальна маса CaO, що надійшла зі шлаком, кг
    m_SiO2_total = m_SiO2_ox + m_lime * x_SiO2_lime  # Загальна маса SiO2 у шлаку, кг

    # Визначення повної маси шлаку за спрощеною моделлю через суму оксидів
    m_slag = (m_CaO_total + m_SiO2_total + m_MnO_ox + m_P2O5_ox) / k_main  # Маса шлаку, кг
    m_FeO_slag = w_FeO * m_slag  # Маса оксиду заліза у складі шлаку, кг
    m_Fe_to_slag = m_FeO_slag * (M_Fe / M_FeO)  # Втрати чистого заліза, що пішло в шлак, кг

    m_dust = k_dust * m_charge  # Розрахунок втрат заліза з пилом та викидами, кг

    # Розрахунок нової (уточненої) маси сталі як залишок після віднімання всіх втрат
    m_steel_new = m_charge - (dSi + dMn + dP + dC) - m_Fe_to_slag - m_dust  # кг

    # Перевірка умови завершення: якщо різниця між ітераціями стала дуже малою
    if abs(m_steel_new - m_steel0) < eps_steel or iter_no >= max_iter:
        m_steel = m_steel_new  # Збереження остаточного значення маси сталі
        Yield = (m_steel / m_charge) * 100.0  # Обчислення відсоткового виходу сталі
        break  # Вихід із циклу

    m_steel0 = m_steel_new  # Оновлення значення для наступного кроку ітерації
    iter_no += 1  # Збільшення лічильника кроків

# --- Вивід результатів ---  # Блок відображення обчислених даних у зручному вигляді
if ok:  # Якщо розрахунок успішно завершено
    print('=' * 43)  # Декоративна лінія
    print(f'МАТЕРІАЛЬНИЙ БАЛАНС (Варіант {variant_no})')  # Заголовок з номером варіанта
    print('=' * 43)  # Декоративна лінія

    print(f'1. ШИХТА (База: {m_charge:.0f} кг):')  # Інформація про початкову шихту
    print(f'   Чавун: {m_hm:8.2f} кг')  # Маса чавуну
    print(f'   Брухт: {m_scr:8.2f} кг')  # Маса брухту

    print('-' * 43)  # Розділювач
    print('2. ОКИСНЕНІ ДОМІШКИ (кг):')  # Секція результатів по елементах
    print(f'   Si: {dSi:6.3f}  |  Mn: {dMn:6.3f}  |  P: {dP:6.3f}')  # Кількості окиснених Si, Mn, P

    print('-' * 43)  # Розділювач
    print('3. УТВОРЕНІ ОКСИДИ (кг):')  # Секція результатів по оксидах шлаку
    print(f'   SiO2: {m_SiO2_ox:6.3f} | MnO: {m_MnO_ox:6.3f} | P2O5: {m_P2O5_ox:6.3f}')  # Кількості оксидів

    print('-' * 43)  # Розділювач
    print('4. ГАЗОВА ФАЗА (кг):')  # Секція результатів по газах
    print(f'   CO:  {m_CO:8.2f} | CO2: {m_CO2:8.2f}')  # Маси CO та CO2

    print('-' * 43)  # Розділювач
    print('5. ШЛАК ТА ВАПНО:')  # Секція флюсів
    print(f'   Вапно (для B={B:.1f}): {m_lime:8.2f} кг')  # Розрахункова витрата вапна
    print(f'   Маса шлаку:        {m_slag:8.2f} кг')  # Отримана маса шлаку

    print('-' * 43)  # Розділювач
    print('5. ВТРАТИ ЗАЛІЗА:')  # Секція втрат металу
    print(f'   У шлак (чисте Fe): {m_Fe_to_slag:8.2f} кг')  # Втрати Fe зі шлаком
    print(f'   З пилом:           {m_dust:8.2f} кг')  # Втрати Fe з димом

    print('-' * 43)  # Розділювач
    print('6. РЕЗУЛЬТАТ:')  # Підсумкові показники плавки
    print(f'   Маса сталі:        {m_steel:8.2f} кг')  # Кінцева маса сталі
    print(f'   Вихід придатного:  {Yield:8.2f} %')  # Вихід сталі відносно шихти
    print('=' * 43)  # Завершальна декоративна лінія
