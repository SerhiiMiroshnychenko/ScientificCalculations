clc; clear; % Очищення вікна команд та пам'яті (видалення старих змінних)

% --- Вхідні дані --- % Початок блоку введення вихідних параметрів для розрахунку
variant_no = 20; % Номер варіанта (використовується для ідентифікації розрахунку)
m_charge = 1000.0; % Загальна маса металевої шихти (чавун + брухт) у кг

% Склад чавуну (%) % Вміст хімічних елементів у рідкому чавуні (вихідні дані)
Si_hm = 1.40; Mn_hm = 0.70; P_hm = 0.04; C_hm = 4.60; % Вміст Si, Mn, P, C у чавуні, %

% Параметри шихти та процесу % Технологічні показники та вимоги до плавки
w_scr = 0.300; % Масова частка брухту в металевій шихті (значення від 0 до 1)
B = 3.4; % Задана основність шлаку (цільове відношення CaO до SiO2)

% Склад брухту (%) % Типовий вміст елементів у сталевому брухті (прийняті константи)
Si_scr = 0.25; Mn_scr = 0.40; P_scr = 0.02; C_scr = 0.20; % Вміст Si, Mn, P, C у брухті, %

% Залишковий вміст у сталі (%) % Вміст елементів у металі після закінчення плавки
Si_st = 0.005; Mn_st = 0.10; P_st = 0.015; C_st = 0.10; % Кінцевий вміст Si, Mn, P, C у сталі, %

% Параметри % Додаткові коефіцієнти для моделі розрахунку
alpha_CO = 0.90; % Частка вуглецю, що окиснюється до CO (решта перетворюється на CO2)
x_CaO_lime = 0.90; x_SiO2_lime = 0.02; % Склад вапна: частки оксидів CaO та SiO2
k_main = 0.80; w_FeO = 0.15; k_dust = 0.015; % Коеф. осн. оксидів, вміст FeO у шлаку, втрати з пилом

% Молярні маси % Атомні та молекулярні маси для хімічних розрахунків, г/моль
M_Si = 28.0855; M_SiO2 = 60.0843; % Молярні маси кремнію та його діоксиду
M_Mn = 54.9380; M_MnO = 70.9374; % Молярні маси марганцю та його оксиду
M_P = 30.9738; M_P2O5 = 141.9445; % Молярні маси фосфору та його оксиду
M_C = 12.011; M_CO = 28.010; M_CO2 = 44.009; % Молярні маси вуглецю та його газів
M_Fe = 55.845; M_FeO = 71.844; % Молярні маси заліза та його оксиду

% --- Розрахунок --- % Початок обчислювальної частини алгоритму
m_hm = m_charge * (1.0 - w_scr); % Обчислення маси рідкого чавуну в шихті, кг
m_scr = m_charge * w_scr; % Обчислення маси сталевого брухту в шихті, кг

% Розрахунок загальної маси кожного елемента, що надійшов із шихтовими матеріалами
Si_in = m_hm * (Si_hm/100) + m_scr * (Si_scr/100); % Загальна маса кремнію в шихті, кг
Mn_in = m_hm * (Mn_hm/100) + m_scr * (Mn_scr/100); % Загальна маса марганцю в шихті, кг
P_in  = m_hm * (P_hm/100)  + m_scr * (P_scr/100); % Загальна маса фосфору в шихті, кг
C_in  = m_hm * (C_hm/100)  + m_scr * (C_scr/100); % Загальна маса вуглецю в шихті, кг

eps_steel = 0.1; % Допустима похибка для зупинки ітераційного уточнення маси сталі, кг
max_iter = 50; % Обмеження кількості ітерацій для запобігання зацикленню
iter_no = 0; % Лічильник фактично виконаних ітерацій
m_steel0 = m_charge; % Початкове наближення маси сталі (приймаємо рівним масі шихти)
ok = true; % Прапор успішного виконання розрахунку (за замовчуванням "істина")

m_steel = 0; Yield = 0; m_slag = 0; m_lime = 0; % Ініціалізація вихідних змінних нулями

while true % Початок ітераційного циклу уточнення (повторюється до збіжності)
    % Розрахунок маси домішок, що залишилися в готовому металі
    Si_st_mass = m_steel0 * (Si_st/100); % Залишок кремнію в сталі, кг
    Mn_st_mass = m_steel0 * (Mn_st/100); % Залишок марганцю в сталі, кг
    P_st_mass  = m_steel0 * (P_st/100); % Залишок фосфору в сталі, кг
    C_st_mass  = m_steel0 * (C_st/100); % Залишок вуглецю в сталі, кг

    % Розрахунок маси окиснених елементів (не менше нуля)
    dSi = max(0, Si_in - Si_st_mass); % Маса кремнію, що окислився, кг
    dMn = max(0, Mn_in - Mn_st_mass); % Маса марганцю, що окислився, кг
    dP  = max(0, P_in  - P_st_mass); % Маса фосфору, що окислився, кг
    dC  = max(0, C_in  - C_st_mass); % Маса вуглецю, що перейшов у гази, кг

    % Перерахунок маси елементів у масу оксидів за допомогою молярних мас (стехіометрія)
    m_SiO2_ox = dSi * (M_SiO2 / M_Si); % Маса діоксиду кремнію, кг
    m_MnO_ox  = dMn * (M_MnO  / M_Mn); % Маса оксиду марганцю, кг
    m_P2O5_ox = dP  * (M_P2O5 / (2.0 * M_P)); % Маса оксиду фосфору, кг

    % Розрахунок маси газів, що утворюються при окисненні вуглецю
    m_CO  = alpha_CO * dC * (M_CO / M_C); % Маса монооксиду вуглецю, кг
    m_CO2 = (1.0 - alpha_CO) * dC * (M_CO2 / M_C); % Маса діоксиду вуглецю, кг

    % Обчислення знаменника для формули вапна (ефективність вапна)
    denom = x_CaO_lime - B * x_SiO2_lime;
    if denom <= 0 % Перевірка: чи дозволяє якість вапна отримати задану основність
        fprintf('Помилка: неможливо забезпечити основність.\n'); % Вивід повідомлення про помилку
        ok = false; % Позначення розрахунку як невдалого
        break; % Примусове завершення циклу
    end

    m_lime = (B * m_SiO2_ox) / denom; % Розрахунок необхідної кількості вапна, кг
    m_CaO_total = m_lime * x_CaO_lime; % Загальна маса CaO, що надійшла зі шлаком, кг
    m_SiO2_total = m_SiO2_ox + m_lime * x_SiO2_lime; % Загальна маса SiO2 у шлаку, кг

    % Визначення повної маси шлаку за спрощеною моделлю через суму оксидів
    m_slag = (m_CaO_total + m_SiO2_total + m_MnO_ox + m_P2O5_ox) / k_main; % кг

    m_FeO_slag = w_FeO * m_slag; % Маса оксиду заліза у складі шлаку, кг
    m_Fe_to_slag = m_FeO_slag * (M_Fe / M_FeO); % Втрати чистого заліза, що пішло в шлак, кг
    m_dust = k_dust * m_charge; % Розрахунок втрат заліза з пилом та викидами, кг

    % Розрахунок нової (уточненої) маси сталі як залишок після віднімання всіх втрат
    m_steel_new = m_charge - (dSi + dMn + dP + dC) - m_Fe_to_slag - m_dust;

    % Перевірка умови завершення: якщо зміна маси стала меншою за eps_steel
    if abs(m_steel_new - m_steel0) < eps_steel || iter_no >= max_iter
        m_steel = m_steel_new; % Збереження остаточного значення маси сталі
        Yield = (m_steel / m_charge) * 100.0; % Обчислення відсоткового виходу сталі
        break; % Вихід із циклу
    end
    
    m_steel0 = m_steel_new; % Оновлення значення для наступного кроку ітерації
    iter_no = iter_no + 1; % Збільшення лічильника кроків
end

% --- Вивід результатів --- % Блок відображення обчислених даних у консолі
if ok % Якщо розрахунок успішно завершено
    fprintf('===========================================\n');
    fprintf('МАТЕРІАЛЬНИЙ БАЛАНС (Варіант %d)\n', variant_no);
    fprintf('===========================================\n');
    
    fprintf('1. ШИХТА (База: %.0f кг):\n', m_charge); % Інформація про шихту
    fprintf('   Чавун: %8.2f кг\n', m_hm); % Вивід маси чавуну
    fprintf('   Брухт: %8.2f кг\n', m_scr); % Вивід маси брухту
    
    fprintf('-------------------------------------------\n');
    fprintf('2. ОКИСНЕНІ ДОМІШКИ (кг):\n'); % Секція результатів по елементах
    fprintf('   Si: %6.3f  |  Mn: %6.3f  |  P: %6.3f\n', dSi, dMn, dP);
    
    fprintf('-------------------------------------------\n');
    fprintf('3. УТВОРЕНІ ОКСИДИ (кг):\n'); % Секція результатів по оксидах
    fprintf('   SiO2: %6.3f | MnO: %6.3f | P2O5: %6.3f\n', m_SiO2_ox, m_MnO_ox, m_P2O5_ox);
    
    fprintf('-------------------------------------------\n');
    fprintf('4. ГАЗОВА ФАЗА (кг):\n'); % Секція результатів по газах
    fprintf('   CO:  %8.2f | CO2: %8.2f\n', m_CO, m_CO2);
    
    fprintf('-------------------------------------------\n');
    fprintf('5. ШЛАК ТА ВАПНО:\n'); % Секція флюсів та шлаку
    fprintf('   Вапно (для B=%.1f): %8.2f кг\n', B, m_lime); % Витрата вапна
    fprintf('   Маса шлаку:        %8.2f кг\n', m_slag); % Отримана маса шлаку
    
    fprintf('-------------------------------------------\n');
    fprintf('5. ВТРАТИ ЗАЛІЗА:\n'); % Секція втрат металу
    fprintf('   У шлак (чисте Fe): %8.2f кг\n', m_Fe_to_slag); % Втрати заліза у шлак
    fprintf('   З пилом:           %8.2f кг\n', m_dust); % Втрати заліза з пилом
    
    fprintf('-------------------------------------------\n');
    fprintf('6. РЕЗУЛЬТАТ:\n'); % Підсумкові показники
    fprintf('   Маса сталі:        %8.2f кг\n', m_steel); % Кінцева маса сталі
    fprintf('   Вихід придатного:  %8.2f %%\n', Yield); % Відсоток виходу металу
    fprintf('===========================================\n');
end
